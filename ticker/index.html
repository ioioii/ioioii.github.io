<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>歩み値変換さん</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
    }
  </style>
</head>
<bodY>
  <input id="period" type="number" value="1" />
  <input id="file" type="file" />
  <div id="output"></div>
  <button id="download-test">Download</button>
  <script>
    const downloadPrices = async () => {
      const query = {
        range: '1d',
        interval: '1m',
        indicators: 'quote',
        includeTimestamps: true,
      };
      const res = await fetch(`https://query1.finance.yahoo.com/v7/finance/chart/7203.T?${new URLSearchParams(query)}`);
      const data = await res.json();
      console.log(data);
    };

    document.querySelector('#download-test').addEventListener('click', () => {
      downloadPrices();
    });

    const periodInput = document.querySelector('#period');
    const fileInput = document.querySelector('#file');
    const output = document.querySelector('#output');

    function csvToArray(text) {
      let p = '', row = [''], ret = [row], i = 0, r = 0, s = !0, l;
      for (l of text) {
          if ('"' === l) {
              if (s && l === p) row[i] += l;
              s = !s;
          } else if (',' === l && s) l = row[++i] = '';
          else if ('\n' === l && s) {
              if ('\r' === p) row[i] = row[i].slice(0, -1);
              row = ret[++r] = [l = '']; i = 0;
          } else row[i] += l;
          p = l;
      }
      return ret;
    };
    
    const readSbiCsv = (file) => new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = () => {
        const txt = reader.result;
        resolve(txt);
      };
      reader.readAsText(file);
    });

    fileInput.addEventListener('change', async (e) => {
      if (e.target.files.length === 0) return;

      const period = parseInt(periodInput.value);

      const file = e.target.files[0];
      const body = await readSbiCsv(file);
      const holeRows = csvToArray(body);
      const rows = holeRows.slice(1, holeRows.length - 1);

      fileInput.value = null;
      const groups = {};

      rows.forEach((row) => {
        const date = new Date(`${row[0].replaceAll("/", "-")}T${row[1]}+09:00`);
        const groupMod = date.getTime() % (period * 60 * 1000);
        const group = date.getTime() - groupMod;

        if (!groups[group]) {
          groups[group] = []
        }

        groups[group].push({
          contract: parseFloat(row[2].replaceAll(',', '')),
          volume: parseInt(row[3].replaceAll(',', '')),
        });
      });

      const candles = Object.keys(groups).map((group) => {
        const date = new Date(parseInt(group));
        const contracts = groups[group].map((r) => r.contract);
        const volumes = groups[group].map((r) => r.volume);
        const open = contracts[groups[group].length - 1];
        const high = Math.max(...contracts);
        const low = Math.min(...contracts);
        const close = contracts[0];
        const volume = volumes.reduce((acc, v) => acc + v, 0);
        return {
          date,
          open,
          high,
          low,
          close,
          volume,
        }
      });

      const candleRows = candles.map((c) => {
        return `${c.date.toLocaleString()},${c.open},${c.high},${c.low},${c.close},${c.volume}`;
      });

      output.innerText = `日付,始値,高値,安値,終値,出来高\n` + candleRows.join('\n');
    });
  </script>
</bodY>
</html>